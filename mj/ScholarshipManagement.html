<!DOCTYPE html>
<html lang="en">
<head>
    <title>Scholarship Management</title>
    <link rel="stylesheet" type="text/css" href="main.css">
    <!-- <script src="./node_modules/web3/dist/web3.min.js">
    </script> -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.4/dist/web3.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Itim&display=swap');
    </style>    
</head>

<body>
    <div class="status" id="status">กำลังโหลด...</div>
    <h1>Scholarship Management</h1>
    <div class="container">
        <!-- Navigation buttons -->
        <div class="nav">
            <button class="nav-btn active" style="font-family: 'Itim', cursive;" onclick="showPage('transactions', event)">Add Transaction</button>
            <button class="nav-btn" style="font-family: 'Itim', cursive;" onclick="showPage('list', event)">Scholarship Recipients List</button>
        </div>
    
        <!-- Transactions Page -->
        <div id="transactions" class="page active form-container">
            <form action="/submit" method="post">
                <h2>Scholarship Transaction</h2>
    
                <label for="recipient_id">Recipient ID :</label>
                <input type="text" id="recipient_id" name="recipient_id" style="font-family: 'Itim', cursive;" required>
    
                <label for="recipient_name">Recipient Name :</label>
                <input type="text" id="recipient_name" name="recipient_name" style="font-family: 'Itim', cursive;" required>
    
                <label for="grant_name">Grant Name :</label>
                <select id="grant_name" name="grant_name" style="font-family: 'Itim', cursive;" required>
                    <option value="pending">Excellence in Education Scholarship (ทุนความเป็นเลิศทางการศึกษา)</option>
                    <option value="approved">Future Leaders Grant (ทุนผู้นำแห่งอนาคต)</option>
                    <option value="rejected">STEM Innovation Scholarship (ทุนนวัตกรรมด้าน STEM)</option>
                    <option value="approved">Global Opportunity Scholarship (ทุนโอกาสระดับโลก)</option>
                    <option value="rejected">Community Impact Award (ทุนเพื่อการพัฒนาสังคม)</option>
                </select>
    
                <label for="grant_amount">Grant Amount :</label>
                <input type="number" id="grant_amount" name="grant_amount" style="font-family: 'Itim', cursive;" required>
    
                <label for="grant_date">Grant Date :</label>
                <input type="date" id="grant_date" name="grant_date" style="font-family: 'Itim', cursive;" required>
    
                <label for="approver">Approver :</label>
                <input type="text" id="approver" name="approver" style="font-family: 'Itim', cursive;" required>
    
                <label for="status">Status :</label>
                <select id="status" name="status" style="font-family: 'Itim', cursive;" required>
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                </select>
    
                <button type="submit" style="font-family: 'Itim', cursive;">Submit</button>
            </form>  
        </div>

        <!-- Recipients List Page -->
        <div id="list" class="page">
            <h2>Scholarship Recipients List</h2>
            <div class="list-grid"></div>
        </div>
    </div>
    

    <script>
        let currentAccount = null;
        const CONTRACT_ADDRESS = "0xe1D4BC9de9bC2123e63bF97A232927926c184b6a"; 
        const ABI = [
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [],
		"name": "closeScholarshipProgram",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "depositFunds",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "studentAddress",
				"type": "address"
			}
		],
		"name": "getStudentInfo",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "openScholarshipProgram",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "studentAddress",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "studentName",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "registerStudent",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "scholarshipActive",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "students",
		"outputs": [
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "scholarshipAmount",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "isEligible",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "totalFunds",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "studentAddress",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "newAmount",
				"type": "uint256"
			}
		],
		"name": "updateScholarshipAmount",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address payable",
				"name": "studentAddress",
				"type": "address"
			}
		],
		"name": "withdrawScholarship",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	}
];
        

async function loadWeb3() {
            if (window.ethereum) {
                window.web3 = new Web3(window.ethereum);
                try {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    const accounts = await web3.eth.getAccounts();
                    currentAccount = accounts[0];
                    updateStatus(`Connected: ${currentAccount}`);
                } catch (error) {
                    console.error("User denied account access", error);
                    updateStatus("Access Denied!");
                }
            } else {
                updateStatus("Please install MetaMask.");
            }
        }

        async function loadContract() {
            return new web3.eth.Contract(ABI, CONTRACT_ADDRESS);
        }

        function updateStatus(message) {
            document.getElementById("status").textContent = message;
        }

        function showPage(pageId, event) {
            document.querySelectorAll(".page").forEach(page => page.classList.remove("active"));
            document.getElementById(pageId).classList.add("active");

            document.querySelectorAll(".nav-btn").forEach(btn => btn.classList.remove("active"));
            if (event && event.target) {
                event.target.classList.add("active");
            }
        }

        async function submitTransaction(event) {
            event.preventDefault();

            const recipientId = document.getElementById("recipient_id").value;
            const grantName = document.getElementById("grant_name").value;
            const grantAmount = document.getElementById("grant_amount").value;
            const grantDate = document.getElementById("grant_date").value;
            const approver = document.getElementById("approver").value;
            const status = document.getElementById("scholarship_status").value;

            const contract = await loadContract();

            try {
                await contract.methods.addScholarship(
                    recipientId,
                    currentAccount,
                    grantName,
                    grantAmount,
                    grantDate,
                    approver,
                    status
                ).send({ from: currentAccount });
                updateStatus("Transaction submitted successfully.");
                loadRecipients();
            } catch (error) {
                updateStatus("Error submitting transaction: " + error.message);
            }
        }

        async function loadRecipients() {
            const contract = await loadContract();
            try {
                const total = await contract.methods.getTotalScholarships().call();
                const recipientList = document.getElementById("recipientList");
                recipientList.innerHTML = "";

                for (let i = 0; i < total; i++) {
                    const recipient = await contract.methods.getScholarship(i).call();
                    const li = document.createElement("li");
                    li.textContent = `ID: ${recipient.recipientId}, Name: ${recipient.recipient}, Grant: ${recipient.grantName}, Amount: ${recipient.grantAmount}`;
                    recipientList.appendChild(li);
                }
            } catch (error) {
                console.error("Error loading recipients:", error);
            }
        }

        window.onload = async () => {
            await loadWeb3();
            showPage("transactions");
        };
    </script>
</body>
</html>